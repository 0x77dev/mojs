<!DOCTYPE html>

<html>
<head>
  <title>timeline.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="../docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>timeline.coffee</h1>
        

        
      </div>

      
        
        
        
          <div class='highlight'><pre>Easing = <span class="hljs-built_in">require</span> <span class="hljs-string">'../easing'</span>
h      = <span class="hljs-built_in">require</span> <span class="hljs-string">'../h'</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Timeline</span></span>
  <span class="hljs-attribute">defaults</span>:
    <span class="hljs-attribute">duration</span>:         <span class="hljs-number">600</span>
    <span class="hljs-attribute">delay</span>:            <span class="hljs-number">0</span>
    <span class="hljs-attribute">repeat</span>:           <span class="hljs-number">0</span>
    <span class="hljs-attribute">yoyo</span>:             <span class="hljs-literal">false</span>
    <span class="hljs-attribute">easing</span>:           <span class="hljs-string">'Linear.None'</span>
    <span class="hljs-attribute">durationElapsed</span>:  <span class="hljs-number">0</span>
    <span class="hljs-attribute">delayElapsed</span>:     <span class="hljs-number">0</span>
    <span class="hljs-attribute">onStart</span>:          <span class="hljs-literal">null</span>
    <span class="hljs-attribute">onComplete</span>:       <span class="hljs-literal">null</span>
    <span class="hljs-attribute">isChained</span>:        <span class="hljs-literal">false</span>
  <span class="hljs-attribute">constructor</span>:<span class="hljs-function"><span class="hljs-params">(<span class="hljs-property">@o</span>={})</span>-&gt;</span> <span class="hljs-property">@extendDefaults</span>(); <span class="hljs-property">@vars</span>(); @
  <span class="hljs-attribute">vars</span>:<span class="hljs-function">-&gt;</span>
    <span class="hljs-property">@h</span> = h; <span class="hljs-property">@props</span> = {}; <span class="hljs-property">@progress</span> = <span class="hljs-number">0</span>; <span class="hljs-property">@prevTime</span> = <span class="hljs-number">0</span>
    <span class="hljs-property">@calcDimentions</span>()
  <span class="hljs-attribute">calcDimentions</span>:<span class="hljs-function">-&gt;</span>
    <span class="hljs-property">@props</span>.totalTime     = (<span class="hljs-property">@o</span>.repeat+<span class="hljs-number">1</span>)*(<span class="hljs-property">@o</span>.duration+<span class="hljs-property">@o</span>.delay)
    <span class="hljs-property">@props</span>.totalDuration = <span class="hljs-property">@props</span>.totalTime - <span class="hljs-property">@o</span>.delay
    easing = h.splitEasing <span class="hljs-property">@o</span>.easing
    <span class="hljs-property">@props</span>.easing = <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> easing <span class="hljs-keyword">is</span> <span class="hljs-string">'function'</span> <span class="hljs-keyword">then</span> easing
    <span class="hljs-keyword">else</span> Easing[easing[<span class="hljs-number">0</span>]][easing[<span class="hljs-number">1</span>]]<span class="hljs-comment"># or (k)-&gt; k</span>
  <span class="hljs-attribute">extendDefaults</span>:<span class="hljs-function">-&gt;</span> h.extend(<span class="hljs-property">@o</span>, <span class="hljs-property">@defaults</span>); <span class="hljs-property">@onUpdate</span> = <span class="hljs-property">@o</span>.onUpdate
  <span class="hljs-attribute">start</span>:<span class="hljs-function"><span class="hljs-params">(time)</span>-&gt;</span>
    <span class="hljs-property">@isCompleted</span> = <span class="hljs-literal">false</span>; <span class="hljs-property">@isStarted</span> = <span class="hljs-literal">false</span>
    <span class="hljs-property">@props</span>.startTime = (time <span class="hljs-keyword">or</span> performance.now()) + <span class="hljs-property">@o</span>.delay
    <span class="hljs-property">@props</span>.endTime   = <span class="hljs-property">@props</span>.startTime + <span class="hljs-property">@props</span>.totalDuration
    @
  <span class="hljs-attribute">update</span>:<span class="hljs-function"><span class="hljs-params">(time)</span>-&gt;</span>
    <span class="hljs-keyword">if</span> (time &gt;= <span class="hljs-property">@props</span>.startTime) <span class="hljs-keyword">and</span> (time &lt; <span class="hljs-property">@props</span>.endTime)
      <span class="hljs-property">@isOnReverseComplete</span> = <span class="hljs-literal">false</span>; <span class="hljs-property">@isCompleted</span> = <span class="hljs-literal">false</span>
      <span class="hljs-keyword">if</span> !<span class="hljs-property">@isFirstUpdate</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@o</span>.onFirstUpdate?.apply(@); <span class="hljs-property">@isFirstUpdate</span> = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">if</span> !<span class="hljs-property">@isStarted</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@o</span>.onStart?.apply(@); <span class="hljs-property">@isStarted</span> = <span class="hljs-literal">true</span>
      elapsed = time - <span class="hljs-property">@props</span>.startTime</pre></div>
        
      
        
        <p>in the first repeat or without any repeats</p>

        
          <div class='highlight'><pre>      <span class="hljs-keyword">if</span> elapsed &lt;= <span class="hljs-property">@o</span>.duration <span class="hljs-keyword">then</span> <span class="hljs-property">@setProc</span> elapsed/<span class="hljs-property">@o</span>.duration
      <span class="hljs-keyword">else</span> <span class="hljs-comment"># far in the repeats</span>
        start = <span class="hljs-property">@props</span>.startTime
        isFlip = <span class="hljs-literal">false</span>; cnt = <span class="hljs-number">0</span>
        <span class="hljs-keyword">while</span>(start &lt;= time)
          isFlip = !isFlip
          start += <span class="hljs-keyword">if</span> isFlip <span class="hljs-keyword">then</span> cnt++; <span class="hljs-property">@o</span>.duration <span class="hljs-keyword">else</span> <span class="hljs-property">@o</span>.delay</pre></div>
        
      
        
        <p>is in start point + duration</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">if</span> isFlip
          start = start - <span class="hljs-property">@o</span>.duration
          elapsed = time - start
          <span class="hljs-property">@setProc</span> elapsed/<span class="hljs-property">@o</span>.duration</pre></div>
        
      
        
        <p>yoyo</p>

        
          <div class='highlight'><pre>          <span class="hljs-keyword">if</span> <span class="hljs-property">@o</span>.yoyo <span class="hljs-keyword">and</span> <span class="hljs-property">@o</span>.repeat
            <span class="hljs-property">@setProc</span> <span class="hljs-keyword">if</span> cnt % <span class="hljs-number">2</span> <span class="hljs-keyword">is</span> <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@progress</span></pre></div>
        
      
        
        <p>when reversed progress of 1 should be 0</p>

        
          <div class='highlight'><pre>            <span class="hljs-keyword">else</span> <span class="hljs-number">1</span>-<span class="hljs-keyword">if</span> <span class="hljs-property">@progress</span> <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-property">@progress</span></pre></div>
        
      
        
        <p>is in start point + delay</p>

        
          <div class='highlight'><pre>        <span class="hljs-keyword">else</span> <span class="hljs-property">@setProc</span> <span class="hljs-number">0</span>
      <span class="hljs-keyword">if</span> time &lt; <span class="hljs-property">@prevTime</span> <span class="hljs-keyword">and</span> !<span class="hljs-property">@isFirstUpdateBackward</span>
        <span class="hljs-property">@o</span>.onFirstUpdateBackward?.apply(@); <span class="hljs-property">@isFirstUpdateBackward</span> = <span class="hljs-literal">true</span>
      <span class="hljs-property">@onUpdate</span>? <span class="hljs-property">@easedProgress</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-keyword">if</span> time &gt;= <span class="hljs-property">@props</span>.endTime <span class="hljs-keyword">and</span> !<span class="hljs-property">@isCompleted</span>
        <span class="hljs-property">@setProc</span> <span class="hljs-number">1</span>; <span class="hljs-property">@onUpdate</span>? <span class="hljs-property">@easedProgress</span>
        <span class="hljs-property">@o</span>.onComplete?.apply(@); <span class="hljs-property">@isCompleted</span> = <span class="hljs-literal">true</span>
        <span class="hljs-property">@isOnReverseComplete</span> = <span class="hljs-literal">false</span>
      <span class="hljs-keyword">if</span> time &gt; <span class="hljs-property">@props</span>.endTime <span class="hljs-keyword">or</span> time &lt; <span class="hljs-property">@props</span>.startTime
        <span class="hljs-property">@isFirstUpdate</span> = <span class="hljs-literal">false</span></pre></div>
        
      
        
        <p>reset isFirstUpdateBackward flag if progress went further the end time</p>

        
          <div class='highlight'><pre>      <span class="hljs-property">@isFirstUpdateBackward</span> = <span class="hljs-literal">false</span> <span class="hljs-keyword">if</span> time &gt; <span class="hljs-property">@props</span>.endTime
    <span class="hljs-keyword">if</span> time &lt; <span class="hljs-property">@prevTime</span> <span class="hljs-keyword">and</span> time &lt;= <span class="hljs-property">@props</span>.startTime<span class="hljs-comment"># and @isIt</span>
      <span class="hljs-keyword">if</span> !<span class="hljs-property">@isFirstUpdateBackward</span>
        <span class="hljs-property">@o</span>.onFirstUpdateBackward?.apply(@); <span class="hljs-property">@isFirstUpdateBackward</span> = <span class="hljs-literal">true</span>
      <span class="hljs-keyword">if</span> !<span class="hljs-property">@isOnReverseComplete</span>
        <span class="hljs-property">@isOnReverseComplete</span> = <span class="hljs-literal">true</span>
        <span class="hljs-property">@setProc</span>(<span class="hljs-number">0</span>); !<span class="hljs-property">@o</span>.isChained <span class="hljs-keyword">and</span> <span class="hljs-property">@onUpdate</span>? <span class="hljs-property">@easedProgress</span>
        <span class="hljs-property">@o</span>.onReverseComplete?.apply(@)
    <span class="hljs-property">@prevTime</span> = time
  <span class="hljs-attribute">setProc</span>:<span class="hljs-function"><span class="hljs-params">(p)</span>-&gt;</span> <span class="hljs-property">@progress</span> = p; <span class="hljs-property">@easedProgress</span> = <span class="hljs-property">@props</span>.easing <span class="hljs-property">@progress</span>
  <span class="hljs-attribute">setProp</span>:<span class="hljs-function"><span class="hljs-params">(obj, value)</span>-&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> obj <span class="hljs-keyword">is</span> <span class="hljs-string">'object'</span>
      <span class="hljs-keyword">for</span> key, val <span class="hljs-keyword">of</span> obj
        <span class="hljs-property">@o</span>[key] = val
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> obj <span class="hljs-keyword">is</span> <span class="hljs-string">'string'</span> <span class="hljs-keyword">then</span> <span class="hljs-property">@o</span>[obj] = value
    <span class="hljs-property">@calcDimentions</span>()

<span class="hljs-built_in">module</span>.exports = Timeline</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
