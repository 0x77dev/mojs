<!DOCTYPE html>

<html>
<head>
  <title>burst.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="public/stylesheets/normalize.css" />
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div class="container">
    <div class="page">

      <div class="header">
        
          <h1>burst.coffee</h1>
        

        
      </div>

      
        
        <p>ignore coffescript sudo code</p>
<h2 id="istanbul-ignore-next">istanbul ignore next</h2>

        
          <div class='highlight'><pre>
bitsMap   = <span class="hljs-built_in">require</span> <span class="hljs-string">'./shapes/bitsMap'</span>
Tween     = <span class="hljs-built_in">require</span> <span class="hljs-string">'./tween/tween'</span>
Transit   = <span class="hljs-built_in">require</span> <span class="hljs-string">'./transit'</span>
Swirl     = <span class="hljs-built_in">require</span> <span class="hljs-string">'./swirl'</span>
h         = <span class="hljs-built_in">require</span> <span class="hljs-string">'./h'</span>

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Burst</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Transit</span></span>
  <span class="hljs-attribute">skipProps</span>: <span class="hljs-attribute">childOptions</span>: <span class="hljs-number">1</span>
  <span class="hljs-attribute">defaults</span>:</pre></div>
        
      
        
        <p>presentation props</p>

        
          <div class='highlight'><pre>    <span class="hljs-attribute">count</span>:              <span class="hljs-number">5</span>
    <span class="hljs-attribute">degree</span>:             <span class="hljs-number">360</span>
    <span class="hljs-attribute">opacity</span>:            <span class="hljs-number">1</span>
    <span class="hljs-attribute">randomAngle</span>:        <span class="hljs-number">0</span>
    <span class="hljs-attribute">randomRadius</span>:       <span class="hljs-number">0</span></pre></div>
        
      
        
        <p>position props/el props</p>

        
          <div class='highlight'><pre>    <span class="hljs-attribute">x</span>:                  <span class="hljs-number">100</span>
    <span class="hljs-attribute">y</span>:                  <span class="hljs-number">100</span>
    <span class="hljs-attribute">shiftX</span>:             <span class="hljs-number">0</span>
    <span class="hljs-attribute">shiftY</span>:             <span class="hljs-number">0</span>
    <span class="hljs-attribute">easing</span>:             <span class="hljs-string">'Linear.None'</span></pre></div>
        
      
        
        <p>size props</p>

        
          <div class='highlight'><pre>    <span class="hljs-attribute">radius</span>:             { <span class="hljs-number">25</span>: <span class="hljs-number">75</span> }
    <span class="hljs-attribute">radiusX</span>:            <span class="hljs-literal">undefined</span>
    <span class="hljs-attribute">radiusY</span>:            <span class="hljs-literal">undefined</span>
    <span class="hljs-attribute">angle</span>:              <span class="hljs-number">0</span>
    <span class="hljs-attribute">size</span>:               <span class="hljs-literal">null</span>
    <span class="hljs-attribute">sizeGap</span>:            <span class="hljs-number">0</span></pre></div>
        
      
        
        <p>callbacks</p>

        
          <div class='highlight'><pre>    <span class="hljs-attribute">duration</span>:           <span class="hljs-number">600</span>
    <span class="hljs-attribute">delay</span>:              <span class="hljs-number">0</span>
    <span class="hljs-attribute">onStart</span>:            <span class="hljs-literal">null</span>
    <span class="hljs-attribute">onComplete</span>:         <span class="hljs-literal">null</span>
    <span class="hljs-attribute">onCompleteChain</span>:    <span class="hljs-literal">null</span>
    <span class="hljs-attribute">onUpdate</span>:           <span class="hljs-literal">null</span>
    <span class="hljs-attribute">isResetAngles</span>:      <span class="hljs-literal">false</span>

  <span class="hljs-attribute">childDefaults</span>:</pre></div>
        
      
        
        <p>— intersection starts</p>

        
          <div class='highlight'><pre>    <span class="hljs-attribute">radius</span>:             { <span class="hljs-number">7</span> : <span class="hljs-number">0</span> }
    <span class="hljs-attribute">radiusX</span>:            <span class="hljs-literal">undefined</span>
    <span class="hljs-attribute">radiusY</span>:            <span class="hljs-literal">undefined</span>
    <span class="hljs-attribute">angle</span>:              <span class="hljs-number">0</span>
    <span class="hljs-attribute">opacity</span>:            <span class="hljs-number">1</span></pre></div>
        
      
        
        <p>callbacks</p>

        
          <div class='highlight'><pre>    <span class="hljs-attribute">onStart</span>:            <span class="hljs-literal">null</span>
    <span class="hljs-attribute">onComplete</span>:         <span class="hljs-literal">null</span>
    <span class="hljs-attribute">onUpdate</span>:           <span class="hljs-literal">null</span></pre></div>
        
      
        
        <p>— intersection ends</p>

        
          <div class='highlight'><pre>    <span class="hljs-attribute">points</span>:             <span class="hljs-number">3</span>
    <span class="hljs-attribute">duration</span>:           <span class="hljs-number">500</span>
    <span class="hljs-attribute">delay</span>:              <span class="hljs-number">0</span>
    <span class="hljs-attribute">repeat</span>:             <span class="hljs-number">0</span>
    <span class="hljs-attribute">yoyo</span>:               <span class="hljs-literal">false</span>
    <span class="hljs-attribute">easing</span>:             <span class="hljs-string">'Linear.None'</span>
    <span class="hljs-attribute">type</span>:               <span class="hljs-string">'circle'</span>
    <span class="hljs-attribute">fill</span>:               <span class="hljs-string">'deeppink'</span>
    <span class="hljs-attribute">fillOpacity</span>:        <span class="hljs-number">1</span>
    <span class="hljs-attribute">isSwirl</span>:            <span class="hljs-literal">false</span>
    <span class="hljs-attribute">swirlSize</span>:          <span class="hljs-number">10</span>
    <span class="hljs-attribute">swirlFrequency</span>:     <span class="hljs-number">3</span>
    <span class="hljs-attribute">stroke</span>:             <span class="hljs-string">'transparent'</span>
    <span class="hljs-attribute">strokeWidth</span>:        <span class="hljs-number">0</span>
    <span class="hljs-attribute">strokeOpacity</span>:      <span class="hljs-number">1</span>
    <span class="hljs-attribute">strokeDasharray</span>:    <span class="hljs-string">''</span>
    <span class="hljs-attribute">strokeDashoffset</span>:   <span class="hljs-string">''</span>
    <span class="hljs-attribute">strokeLinecap</span>:      <span class="hljs-literal">null</span>
  <span class="hljs-attribute">optionsIntersection</span>:
    <span class="hljs-attribute">radius</span>:     <span class="hljs-number">1</span>
    <span class="hljs-attribute">radiusX</span>:    <span class="hljs-number">1</span>
    <span class="hljs-attribute">radiusY</span>:    <span class="hljs-number">1</span>
    <span class="hljs-attribute">angle</span>:      <span class="hljs-number">1</span>
    <span class="hljs-attribute">opacity</span>:    <span class="hljs-number">1</span>
    <span class="hljs-attribute">onStart</span>:    <span class="hljs-number">1</span>
    <span class="hljs-attribute">onComplete</span>: <span class="hljs-number">1</span>
    <span class="hljs-attribute">onUpdate</span>:   <span class="hljs-number">1</span>
  <span class="hljs-attribute">run</span>:<span class="hljs-function"><span class="hljs-params">(o)</span>-&gt;</span>
    <span class="hljs-keyword">if</span> o? <span class="hljs-keyword">and</span> Object.keys(o).length
      <span class="hljs-keyword">if</span> o.count <span class="hljs-keyword">or</span> o.childOptions?.count
        <span class="hljs-property">@h</span>.warn <span class="hljs-string">'Sorry, count can not be changed on run'</span>
      <span class="hljs-property">@extendDefaults</span>(o)</pre></div>
        
      
        
        <p>copy child options to options</p>

        
          <div class='highlight'><pre>      keys = Object.keys(o.childOptions <span class="hljs-keyword">or</span> {})
      <span class="hljs-property">@o</span>.childOptions ?= {}
      <span class="hljs-keyword">for</span> key, i <span class="hljs-keyword">in</span> keys
        <span class="hljs-property">@o</span>.childOptions[key] = o.childOptions[key]</pre></div>
        
      
        
        <p>tune transits</p>

        
          <div class='highlight'><pre>      len = <span class="hljs-property">@transits</span>.length
      <span class="hljs-keyword">while</span>(len--)
        transit = <span class="hljs-property">@transits</span>[len]
        transit.tuneNewOption <span class="hljs-property">@getOption</span>(len), <span class="hljs-literal">true</span>
      <span class="hljs-property">@tween</span>.recalcDuration()
    <span class="hljs-keyword">if</span> <span class="hljs-property">@props</span>.randomAngle <span class="hljs-keyword">or</span> <span class="hljs-property">@props</span>.randomRadius
      len = <span class="hljs-property">@transits</span>.length
      <span class="hljs-keyword">while</span>(len--)
        tr = <span class="hljs-property">@transits</span>[len]
        <span class="hljs-property">@props</span>.randomAngle  <span class="hljs-keyword">and</span> tr.setProp <span class="hljs-attribute">angleShift</span>:  <span class="hljs-property">@generateRandomAngle</span>()
        <span class="hljs-property">@props</span>.randomRadius <span class="hljs-keyword">and</span> tr.setProp <span class="hljs-attribute">radiusScale</span>: <span class="hljs-property">@generateRandomRadius</span>()
    <span class="hljs-property">@startTween</span>()
    
  <span class="hljs-attribute">createBit</span>:<span class="hljs-function">-&gt;</span>
    <span class="hljs-property">@transits</span> = []
    <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> [<span class="hljs-number">0.</span>..<span class="hljs-property">@props</span>.count]
      option = <span class="hljs-property">@getOption</span>(i); option.ctx = <span class="hljs-property">@ctx</span>; option.index = i
      option.isDrawLess = option.isRunLess = option.isTweenLess = <span class="hljs-literal">true</span>
      <span class="hljs-property">@props</span>.randomAngle  <span class="hljs-keyword">and</span> (option.angleShift  = <span class="hljs-property">@generateRandomAngle</span>())
      <span class="hljs-property">@props</span>.randomRadius <span class="hljs-keyword">and</span> (option.radiusScale = <span class="hljs-property">@generateRandomRadius</span>())
      <span class="hljs-property">@transits</span>.push <span class="hljs-keyword">new</span> Swirl option

  <span class="hljs-attribute">addBitOptions</span>:<span class="hljs-function">-&gt;</span>
    points = <span class="hljs-property">@props</span>.count
    <span class="hljs-property">@degreeCnt</span> = <span class="hljs-keyword">if</span> <span class="hljs-property">@props</span>.degree % <span class="hljs-number">360</span> <span class="hljs-keyword">is</span> <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> points <span class="hljs-keyword">else</span> points-<span class="hljs-number">1</span> <span class="hljs-keyword">or</span> <span class="hljs-number">1</span>
    
    step = <span class="hljs-property">@props</span>.degree/<span class="hljs-property">@degreeCnt</span>
    <span class="hljs-keyword">for</span> transit, i <span class="hljs-keyword">in</span> <span class="hljs-property">@transits</span>
      aShift = transit.props.angleShift
      pointStart = <span class="hljs-property">@getSidePoint</span> <span class="hljs-string">'start'</span>, i*step + aShift
      pointEnd   = <span class="hljs-property">@getSidePoint</span> <span class="hljs-string">'end'</span>,   i*step + aShift

      transit.o.x = <span class="hljs-property">@getDeltaFromPoints</span> <span class="hljs-string">'x'</span>, pointStart, pointEnd
      transit.o.y = <span class="hljs-property">@getDeltaFromPoints</span> <span class="hljs-string">'y'</span>, pointStart, pointEnd

      <span class="hljs-keyword">if</span> !<span class="hljs-property">@props</span>.isResetAngles
        angleAddition = i*step + <span class="hljs-number">90</span>
        transit.o.angle = <span class="hljs-keyword">if</span> <span class="hljs-keyword">typeof</span> transit.o.angle <span class="hljs-keyword">isnt</span> <span class="hljs-string">'object'</span>
          transit.o.angle + angleAddition + aShift
        <span class="hljs-keyword">else</span>
          keys = Object.keys(transit.o.angle); start = keys[<span class="hljs-number">0</span>]
          end   = transit.o.angle[start]
          newStart = parseFloat(start) + angleAddition + aShift
          newEnd   = parseFloat(end)   + angleAddition + aShift
          delta = {}; delta[newStart] = newEnd
          delta
      transit.extendDefaults()
  <span class="hljs-attribute">getSidePoint</span>:<span class="hljs-function"><span class="hljs-params">(side, angle)</span>-&gt;</span>
    sideRadius = <span class="hljs-property">@getSideRadius</span> side
    pointStart = <span class="hljs-property">@h</span>.getRadialPoint
      <span class="hljs-attribute">radius</span>:  sideRadius.radius
      <span class="hljs-attribute">radiusX</span>: sideRadius.radiusX
      <span class="hljs-attribute">radiusY</span>: sideRadius.radiusY
      <span class="hljs-attribute">angle</span>:   angle
      <span class="hljs-attribute">center</span>:  <span class="hljs-attribute">x</span>: <span class="hljs-property">@props</span>.center, <span class="hljs-attribute">y</span>: <span class="hljs-property">@props</span>.center
  <span class="hljs-attribute">getSideRadius</span>:<span class="hljs-function"><span class="hljs-params">(side)</span>-&gt;</span>
    <span class="hljs-attribute">radius</span>:  <span class="hljs-property">@getRadiusByKey</span> <span class="hljs-string">'radius'</span>,  side
    <span class="hljs-attribute">radiusX</span>: <span class="hljs-property">@getRadiusByKey</span> <span class="hljs-string">'radiusX'</span>, side
    <span class="hljs-attribute">radiusY</span>: <span class="hljs-property">@getRadiusByKey</span> <span class="hljs-string">'radiusY'</span>, side
  <span class="hljs-attribute">getRadiusByKey</span>:<span class="hljs-function"><span class="hljs-params">(key, side)</span>-&gt;</span>
    <span class="hljs-keyword">if</span> <span class="hljs-property">@deltas</span>[key]? <span class="hljs-keyword">then</span> <span class="hljs-property">@deltas</span>[key][side]
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> <span class="hljs-property">@props</span>[key]? <span class="hljs-keyword">then</span> <span class="hljs-property">@props</span>[key]
  <span class="hljs-attribute">getDeltaFromPoints</span>:<span class="hljs-function"><span class="hljs-params">(key, pointStart, pointEnd)</span>-&gt;</span>
    delta = {}
    <span class="hljs-keyword">if</span> pointStart[key] <span class="hljs-keyword">is</span> pointEnd[key] <span class="hljs-keyword">then</span> delta = pointStart[key]
    <span class="hljs-keyword">else</span> delta[pointStart[key]] = pointEnd[key]; delta
  <span class="hljs-attribute">draw</span>:<span class="hljs-function"><span class="hljs-params">(progress)</span>-&gt;</span> <span class="hljs-property">@drawEl</span>()

  <span class="hljs-attribute">isNeedsTransform</span>:<span class="hljs-function">-&gt;</span>
    <span class="hljs-property">@isPropChanged</span>(<span class="hljs-string">'shiftX'</span>)<span class="hljs-keyword">or</span><span class="hljs-property">@isPropChanged</span>(<span class="hljs-string">'shiftY'</span>)<span class="hljs-keyword">or</span><span class="hljs-property">@isPropChanged</span>(<span class="hljs-string">'angle'</span>)
  <span class="hljs-attribute">fillTransform</span>:<span class="hljs-function">-&gt;</span>
    <span class="hljs-string">"rotate(<span class="hljs-subst">#{<span class="hljs-property">@props</span>.angle}</span>deg) translate(<span class="hljs-subst">#{<span class="hljs-property">@props</span>.shiftX}</span>, <span class="hljs-subst">#{<span class="hljs-property">@props</span>.shiftY}</span>)"</span>
  <span class="hljs-attribute">createTween</span>:<span class="hljs-function">-&gt;</span>
    <span class="hljs-keyword">super</span>; i = <span class="hljs-property">@transits</span>.length; <span class="hljs-property">@tween</span>.add(<span class="hljs-property">@transits</span>[i].timeline) <span class="hljs-keyword">while</span>(i--)
    
  <span class="hljs-attribute">calcSize</span>:<span class="hljs-function">-&gt;</span>
    largestSize = -<span class="hljs-number">1</span>
    <span class="hljs-keyword">for</span> transit, i <span class="hljs-keyword">in</span> <span class="hljs-property">@transits</span>
      transit.calcSize()
      <span class="hljs-keyword">if</span> largestSize &lt; transit.props.size
        largestSize = transit.props.size
    radius = <span class="hljs-property">@calcMaxRadius</span>()
    <span class="hljs-property">@props</span>.size   = largestSize + <span class="hljs-number">2</span>*radius
    <span class="hljs-property">@props</span>.size   += <span class="hljs-number">2</span>*<span class="hljs-property">@props</span>.sizeGap
    <span class="hljs-property">@props</span>.center = <span class="hljs-property">@props</span>.size/<span class="hljs-number">2</span>
    <span class="hljs-property">@addBitOptions</span>()

  <span class="hljs-attribute">getOption</span>:<span class="hljs-function"><span class="hljs-params">(i)</span>-&gt;</span>
    option = {}; keys = Object.keys(<span class="hljs-property">@childDefaults</span>); len = keys.length
    <span class="hljs-keyword">while</span>(len--)
      key = keys[len]</pre></div>
        
      
        
        <p>firstly try to find the prop in @o.childOptions</p>

        
          <div class='highlight'><pre>      option[key]  = <span class="hljs-property">@getPropByMod</span> <span class="hljs-attribute">key</span>: key, <span class="hljs-attribute">i</span>: i, <span class="hljs-attribute">from</span>: <span class="hljs-property">@o</span>.childOptions</pre></div>
        
      
        
        <p>if fail
if the same option could be defined for parent and child
get the option from childDefaults and continue</p>

        
          <div class='highlight'><pre>      <span class="hljs-keyword">if</span> <span class="hljs-property">@optionsIntersection</span>[key]
        option[key] ?= <span class="hljs-property">@getPropByMod</span> <span class="hljs-attribute">key</span>: key, <span class="hljs-attribute">i</span>: i, <span class="hljs-attribute">from</span>: <span class="hljs-property">@childDefaults</span>
        <span class="hljs-keyword">continue</span></pre></div>
        
      
        
        <p>else check the option on parent</p>

        
          <div class='highlight'><pre>      option[key] ?= <span class="hljs-property">@getPropByMod</span> <span class="hljs-attribute">key</span>: key, <span class="hljs-attribute">i</span>: i, <span class="hljs-attribute">from</span>: <span class="hljs-property">@o</span>
      option[key] ?= <span class="hljs-property">@getPropByMod</span> <span class="hljs-attribute">key</span>: key, <span class="hljs-attribute">i</span>: i, <span class="hljs-attribute">from</span>: <span class="hljs-property">@childDefaults</span>
    option
  <span class="hljs-attribute">getPropByMod</span>:<span class="hljs-function"><span class="hljs-params">(o)</span>-&gt;</span>
    prop = (o.from <span class="hljs-keyword">or</span> <span class="hljs-property">@o</span>.childOptions)?[o.key]
    <span class="hljs-keyword">if</span> <span class="hljs-property">@h</span>.isArray(prop) <span class="hljs-keyword">then</span> prop[o.i % prop.length] <span class="hljs-keyword">else</span> prop
  <span class="hljs-attribute">generateRandomAngle</span>:<span class="hljs-function"><span class="hljs-params">(i)</span>-&gt;</span>
    randomness = parseFloat(<span class="hljs-property">@props</span>.randomAngle)
    randdomness = <span class="hljs-keyword">if</span> randomness &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> randomness &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">0</span>
    <span class="hljs-property">@h</span>.rand(<span class="hljs-number">0</span>, <span class="hljs-keyword">if</span> randomness <span class="hljs-keyword">then</span> randomness*<span class="hljs-number">360</span> <span class="hljs-keyword">else</span> <span class="hljs-number">180</span>)
  <span class="hljs-attribute">generateRandomRadius</span>:<span class="hljs-function"><span class="hljs-params">(i)</span>-&gt;</span>
    randomness = parseFloat(<span class="hljs-property">@props</span>.randomRadius)
    randdomness = <span class="hljs-keyword">if</span> randomness &gt; <span class="hljs-number">1</span> <span class="hljs-keyword">then</span> <span class="hljs-number">1</span> <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> randomness &lt; <span class="hljs-number">0</span> <span class="hljs-keyword">then</span> <span class="hljs-number">0</span>
    start = <span class="hljs-keyword">if</span> randomness <span class="hljs-keyword">then</span> (<span class="hljs-number">1</span>-randomness)*<span class="hljs-number">100</span> <span class="hljs-keyword">else</span> (<span class="hljs-number">1</span>-.<span class="hljs-number">5</span>)*<span class="hljs-number">100</span>
    <span class="hljs-property">@h</span>.rand(start, <span class="hljs-number">100</span>)/<span class="hljs-number">100</span>

  <span class="hljs-attribute">then</span>:<span class="hljs-function"><span class="hljs-params">(o)</span>-&gt;</span>
    <span class="hljs-property">@h</span>.error <span class="hljs-string">"Burst's \"then\" method is under consideration,
      you can vote for it in github repo issues"</span></pre></div>
        
      
        
        <ol>
<li>merge @o and o</li>
<li>get i option from merged object</li>
<li>pass the object to transit then</li>
<li>transform self chain on run
i = @transits.length
while(i—)
@transits[i].then(o)</li>
</ol>

        
          <div class='highlight'><pre>    @

<span class="hljs-built_in">module</span>.exports = Burst</pre></div>
        
      
      <div class="fleur">h</div>
    </div>
  </div>
</body>
</html>
